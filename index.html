<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> -->

    <title>My ModuleAir sign in</title>

    <link
      rel="icon"
      type="image/x-icon"
      href="https://moduleair.fr/img/favicon.png"
    />

    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM"
      crossorigin="anonymous"
    />

    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous"> -->

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
      integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
      integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
      crossorigin=""
    ></script>

    <!-- Fontawesome
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css"> -->

    <!-- Amcharts -->
    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/radar.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/plugins/exporting.js"></script>

    <style>
      /* Google Fonts - Poppins */
      @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap");

      :root {
        --primary-color: #2563eb;
        --primary-hover: #1d4ed8;
        --secondary-color: #64748b;
        --success-color: #10b981;
        --warning-color: #f59e0b;
        --danger-color: #ef4444;
        --background-color: #e2e8f0;
        --card-background: #ffffff;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --border-color: #cbd5e1;
        --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.15), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, 0.2), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 16px;
        --transition: all 0.2s ease;
      }

      *, *::before, *::after {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Poppins", sans-serif;
      }

      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        overflow-x: hidden;
      }

      body {
        background-color: var(--background-color);
        color: var(--text-primary);
      }

      #container_form {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        min-height: 100vh;
        width: 100vw;
        display: flex;
        align-items: center;
        justify-content: center;
        background-image: url('https://aircarto.fr/images/topo_big3.png');
        background-repeat: no-repeat;
        background-size: cover;
        background-position: center;
        background-color: #f0f4f8;
        padding: 20px;
      }

      #container_graphs {
        min-height: 100vh;
        width: 100%;
        background-color: var(--background-color);
        display: none;
        padding-bottom: 40px;
      }

      /* Header sticky */
      .app-header {
        background: var(--card-background);
        box-shadow: var(--shadow-md);
        padding: 16px 0;
        position: sticky;
        top: 0;
        z-index: 1000;
        margin-bottom: 24px;
      }

      .app-header .container-fluid {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .app-header img {
        height: 45px;
      }

      .btn-logout {
        background: transparent;
        border: 2px solid var(--danger-color);
        color: var(--danger-color);
        padding: 8px 20px;
        border-radius: var(--radius-sm);
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
      }

      .btn-logout:hover {
        background: var(--danger-color);
        color: white;
      }

      .form {
        max-width: 430px;
        width: 100%;
        padding: 40px;
        border-radius: var(--radius-lg);
        background: var(--card-background);
        box-shadow: var(--shadow-lg);
      }

      .form.signup {
        opacity: 0;
        pointer-events: none;
      }

      .forms.show-signup .form.signup {
        opacity: 1;
        pointer-events: auto;
      }

      .forms.show-signup .form.login {
        opacity: 0;
        pointer-events: none;
      }

      header {
        font-size: 28px;
        font-weight: 700;
        color: var(--text-primary);
        text-align: center;
      }

      form {
        margin-top: 30px;
      }

      .form .field {
        position: relative;
        height: 50px;
        width: 100%;
        margin-top: 20px;
        border-radius: var(--radius-sm);
      }

      .field input,
      .field button {
        height: 100%;
        width: 100%;
        border: none;
        font-size: 16px;
        font-weight: 400;
        border-radius: var(--radius-sm);
      }

      .field input {
        outline: none;
        padding: 0 15px;
        border: 2px solid var(--border-color);
        transition: var(--transition);
      }

      .field input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .eye-icon {
        position: absolute;
        top: 50%;
        right: 10px;
        transform: translateY(-50%);
        font-size: 18px;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 5px;
        transition: var(--transition);
      }

      .eye-icon:hover {
        color: var(--primary-color);
      }

      .field button {
        color: #fff;
        background: linear-gradient(135deg, var(--primary-color) 0%, #4f46e5 100%);
        transition: var(--transition);
        cursor: pointer;
        font-weight: 600;
      }

      .field button:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      .form a {
        color: var(--primary-color);
        text-decoration: none;
      }

      .form-content a:hover {
        text-decoration: underline;
      }

      /* Cards modernes */
      .card {
        background: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-md);
        transition: var(--transition);
      }

      .card:hover {
        box-shadow: var(--shadow-lg);
      }

      .card-body {
        padding: 24px;
      }

      .card-title {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 16px;
      }

      /* Time buttons - Pills style */
      .time-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 16px;
      }

      .time-controls-group {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }

      .time-controls-label {
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 14px;
        min-width: 100px;
      }

      .time-btn {
        padding: 8px 16px;
        border-radius: 20px;
        border: 2px solid var(--border-color);
        background: var(--card-background);
        color: var(--text-secondary);
        font-weight: 500;
        font-size: 14px;
        cursor: pointer;
        transition: var(--transition);
      }

      .time-btn:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
      }

      .time-btn.active, .time-btn.btn-secondary {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
      }

      .time-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Pollutant toggle buttons */
      .pollutant-toggles {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
        padding: 16px;
        background: var(--background-color);
        border-radius: var(--radius-md);
      }

      .toggle-btn {
        padding: 10px 18px;
        border-radius: var(--radius-sm);
        border: 2px solid var(--border-color);
        background: var(--card-background);
        color: var(--text-secondary);
        font-weight: 500;
        font-size: 14px;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .toggle-btn:hover {
        border-color: var(--primary-color);
      }

      .toggle-btn.active {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
      }

      .toggle-btn .color-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
      }

      /* Color dots for pollutants - PM in green gradient */
      .toggle-btn[data-series="PM1"] .color-dot { background: #2d6a4f; }
      .toggle-btn[data-series="PM25"] .color-dot { background: #40916c; }
      .toggle-btn[data-series="PM10"] .color-dot { background: #74c69d; }
      .toggle-btn[data-series="TEMP"] .color-dot { background: #ff6b6b; }
      .toggle-btn[data-series="HUM"] .color-dot { background: #4ecdc4; }
      .toggle-btn[data-series="COV"] .color-dot { background: #f39c12; }
      .toggle-btn[data-series="CO2"] .color-dot { background: #e74c3c; }

      /* Gauge charts */
      .gauges-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 16px;
      }

      #chartdiv1, #chartdiv2, #chartdiv3, #chartdiv4 {
        width: 220px;
        height: 220px;
      }

      /* Unified chart */
      #unifiedChart {
        width: 100%;
        height: 550px;
        max-width: 100%;
      }

      /* Map */
      #map {
        height: 450px;
        border-radius: var(--radius-md);
        overflow: hidden;
      }

      .address {
        cursor: pointer;
        border: 2px solid var(--primary-color);
        border-radius: var(--radius-sm);
        padding: 12px;
        margin: 8px 0;
        transition: var(--transition);
      }

      .address:hover {
        background-color: rgba(37, 99, 235, 0.1);
      }

      /* Form controls */
      .form-control, .form-select {
        border: 2px solid var(--border-color);
        border-radius: var(--radius-sm);
        padding: 10px 14px;
        transition: var(--transition);
      }

      .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .btn-success {
        background: var(--success-color);
        border: none;
        border-radius: var(--radius-sm);
        padding: 10px 24px;
        font-weight: 500;
        transition: var(--transition);
      }

      .btn-success:hover {
        background: #059669;
        transform: translateY(-1px);
      }

      .btn-outline-secondary {
        border: 2px solid var(--border-color);
        color: var(--text-secondary);
        border-radius: var(--radius-sm);
        transition: var(--transition);
      }

      .btn-outline-secondary:hover {
        background: var(--background-color);
        border-color: var(--secondary-color);
      }

      /* Spacing utilities */
      .section-gap {
        margin-top: 24px;
      }

      /* Responsive */
      @media screen and (max-width: 768px) {
        .form {
          padding: 24px 16px;
        }

        .app-header .container-fluid {
          flex-direction: column;
          gap: 12px;
        }

        #chartdiv1, #chartdiv2, #chartdiv3, #chartdiv4 {
          width: 160px;
          height: 160px;
        }

        .pollutant-toggles {
          justify-content: center;
        }

        .time-controls-group {
          width: 100%;
          justify-content: center;
        }

        .time-controls-label {
          width: 100%;
          text-align: center;
        }
      }

      @media screen and (max-width: 400px) {
        .form {
          padding: 20px 12px;
        }

        #chartdiv1, #chartdiv2, #chartdiv3, #chartdiv4 {
          width: 140px;
          height: 140px;
        }
      }

      /* Sensor info styling */
      .sensor-info {
        display: flex;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
      }

      .sensor-status {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: rgba(16, 185, 129, 0.1);
        border-radius: 20px;
        color: var(--success-color);
        font-weight: 500;
        font-size: 14px;
      }

      /* Hide old chart divs */
      #chartdiv5, #chartdiv6, #chartdiv7, #chartdiv8 {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="toast-container position-fixed end-0 p-3" style="bottom: 10px">
      <div
        class="toast align-items-center"
        id="messageToast"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
      >
        <div class="d-flex">
          <div class="toast-body">Attention: <span id="message"></span></div>
        </div>
      </div>
    </div>

    <div class="container">

    <section id="container_form">
      <div class="form login">
        <div class="form-content">
          <header><h2 class="fw-bold mb-2">Mon ModuleAir</h2></header>
          <p style="text-align: center">
            Veuillez entrer le nom du ModuleAir ainsi que son token (indiqué au
            dos de l'appareil)
          </p>
          <div class="field input-field">
            <input
              type="text"
              placeholder="Nom (device ID)"
              class="input"
              id="moduleair"
            />
          </div>

          <div class="field input-field">
            <input
              type="password"
              placeholder="Token"
              class="password"
              id="token"
            />
            <i class="fa-solid fa-eye-slash eye-icon"></i>
          </div>

          <div class="field button-field">
            <button id="submit">Se connecter</button>
          </div>
        </div>
      </div>
    </section>

    <section id="container_graphs">
      <!-- Sticky Header -->
      <div class="app-header">
        <div class="container-fluid">
          <div class="d-flex align-items-center gap-3">
            <img src="/img/logoModuleAirColor_long.png" alt="ModuleAir" />
            <img src="./img/LogoAirCarto.png" alt="AirCarto" />
          </div>
          <button class="btn-logout" id="logout">
            <i class="fa-solid fa-right-from-bracket"></i> Déconnexion
          </button>
        </div>
      </div>

      <div class="container-fluid">

        <div class="row section-gap">
          <div class="col-sm-12">
            <div class="card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-4">
                  <div>
                    <h3 class="card-title mb-2">ModuleAir <span id="idm"></span></h3>
                    <div class="sensor-info">
                      <span class="sensor-status">
                        <i class="fa-regular fa-clock"></i>
                        <span id="timestamp"></span>
                      </span>
                    </div>
                  </div>
                  <button type="button" onclick="refresh_data()" class="btn btn-outline-secondary">
                    <i class="fa-solid fa-rotate"></i> Actualiser
                  </button>
                </div>

                <div class="gauges-container">
                  <div id="chartdiv1"></div>
                  <div id="chartdiv2"></div>
                  <div id="chartdiv3"></div>
                  <div id="chartdiv4"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- HISTORIQUE -->
        <div class="row section-gap">
          <div class="col-sm-12">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title mb-3">Historique des mesures</h5>

                <div class="time-controls">
                  <div class="time-controls-group">
                    <span class="time-controls-label">Période :</span>
                    <span id="button1h"></span>
                    <span id="button3h"></span>
                    <span id="button24h"></span>
                    <span id="button48h"></span>
                    <span id="button1s"></span>
                    <span id="button1m"></span>
                    <span id="button1a"></span>
                  </div>
                  <div class="time-controls-group">
                    <span class="time-controls-label">Résolution :</span>
                    <span id="button2m"></span>
                    <span id="button15m"></span>
                    <span id="button60m"></span>
                    <span id="button1440m"></span>
                  </div>
                </div>

                <!-- Pollutant Toggle Buttons -->
                <div class="pollutant-toggles">
                  <button class="toggle-btn active" data-series="CO2" onclick="toggleSeries('CO2')">
                    <span class="color-dot"></span> CO₂ <small>(ppm)</small>
                  </button>
                  <button class="toggle-btn" data-series="PM1" onclick="toggleSeries('PM1')">
                    <span class="color-dot"></span> PM1 <small>(µg/m³)</small>
                  </button>
                  <button class="toggle-btn active" data-series="PM25" onclick="toggleSeries('PM25')">
                    <span class="color-dot"></span> PM2.5 <small>(µg/m³)</small>
                  </button>
                  <button class="toggle-btn" data-series="PM10" onclick="toggleSeries('PM10')">
                    <span class="color-dot"></span> PM10 <small>(µg/m³)</small>
                  </button>
                  <button class="toggle-btn" data-series="TEMP" onclick="toggleSeries('TEMP')">
                    <span class="color-dot"></span> Temp <small>(°C)</small>
                  </button>
                  <button class="toggle-btn" data-series="HUM" onclick="toggleSeries('HUM')">
                    <span class="color-dot"></span> Humidité <small>(%)</small>
                  </button>
                  <button class="toggle-btn" data-series="COV" onclick="toggleSeries('COV')">
                    <span class="color-dot"></span> COV <small>(ppb)</small>
                  </button>
                </div>

                <!-- Unified Chart -->
                <div id="unifiedChart"></div>

                <!-- Hidden old charts for compatibility -->
                <div id="chartdiv5"></div>
                <div id="chartdiv6"></div>
                <div id="chartdiv7"></div>
                <div id="chartdiv8"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- CONNEXION NEBULEAIR-->
        <div class="row section-gap">
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-body">
                <h5 class="card-title">
                  <i class="fa-solid fa-link"></i> Connecter un NebuleAir
                </h5>
                <p class="text-muted mb-3">
                  Liez votre ModuleAir à un NebuleAir pour comparer les mesures intérieures et extérieures.
                </p>
                <div class="d-flex gap-2 align-items-center">
                  <input
                    type="text"
                    id="linkNebuleAir"
                    placeholder="ID du NebuleAir"
                    class="form-control"
                    style="max-width: 200px;"
                  />
                  <button type="button" id="updateLink" class="btn btn-success">
                    <i class="fa-solid fa-check"></i> Valider
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- EMPLACEMENT-->
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-body">
                <h5 class="card-title">
                  <i class="fa-solid fa-house"></i> Position dans la maison
                </h5>
                <p class="text-muted mb-3">
                  Indiquez la pièce dans laquelle se trouve le ModuleAir.
                </p>
                <select id="room" class="form-select" style="max-width: 250px;">
                  <option value="null">Choix de la pièce</option>
                  <option value="cuisine">Cuisine</option>
                  <option value="salle_a_manger">Salle à manger</option>
                  <option value="salon">Salon</option>
                  <option value="chambre_parents">Chambre parents</option>
                  <option value="chambre_enfants">Chambre enfants</option>
                  <option value="toilettes">Toilettes</option>
                  <option value="salle_de_bain">Salle de bain</option>
                  <option value="entree">Entrée</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- MAP CONTROL-->
        <div class="row section-gap">
          <div class="col-sm-12">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">
                  <i class="fa-solid fa-location-dot"></i> Géolocaliser mon capteur
                </h5>

                <div id="search">
                  <div class="d-flex gap-2 mb-3 flex-wrap">
                    <input
                      type="text"
                      name="addr"
                      id="addr"
                      class="form-control"
                      placeholder="Entrez l'adresse du ModuleAir..."
                      style="flex: 1; min-width: 250px;"
                    />
                    <button
                      type="button"
                      class="btn btn-outline-secondary"
                      onclick="addr_search();"
                    >
                      <i class="fa-solid fa-magnifying-glass"></i> Rechercher
                    </button>
                  </div>

                  <div id="results"></div>

                  <div class="d-flex gap-2 align-items-center flex-wrap mt-3">
                    <input
                      type="text"
                      name="new_lat"
                      id="lat"
                      placeholder="Latitude"
                      class="form-control"
                      style="max-width: 150px;"
                    />
                    <input
                      type="text"
                      name="new_lon"
                      id="lon"
                      placeholder="Longitude"
                      class="form-control"
                      style="max-width: 150px;"
                    />
                    <button type="button" id="updateLoc" class="btn btn-success">
                      <i class="fa-solid fa-check"></i> Valider
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- MAP -->
        <div class="row section-gap">
          <div class="col-sm-12">
            <div class="card">
              <div class="card-body p-0" style="overflow: hidden; border-radius: var(--radius-md);">
                <div id="map"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

    <!-- JavaScript -->
    <script>
      var moduleair, token;
      var nebuleair;
      var dataNebuleAir = null;
      var root1, root2, root3, root4, rootUnified;
      var unifiedChart, allSeries = {};
      var allAxes = {}; // Store Y-axes references

      var measureType = "PM";
      var timespanGraph = 2;   // pas de temps en minutes
      var timeLengthGraph = 3;  //historique en heures

      // Toggle states for series visibility
      var seriesVisibility = {
        PM1: false, PM25: true, PM10: false,
        TEMP: false, HUM: false,
        COV: false, CO2: true
      };

      const forms = document.querySelector(".forms"),
        pwShowHide = document.querySelectorAll(".eye-icon");

      document.querySelector("#submit").addEventListener("click", submit);
      document.querySelector("#logout").addEventListener("click", logout);

      // Auto-login from localStorage
      window.addEventListener("DOMContentLoaded", function() {
        const savedModuleair = localStorage.getItem("moduleair_id");
        const savedToken = localStorage.getItem("moduleair_token");

        if (savedModuleair && savedToken) {
          document.querySelector("#moduleair").value = savedModuleair;
          document.querySelector("#token").value = savedToken;
          // Auto-submit after a short delay
          setTimeout(function() {
            submit();
          }, 300);
        }
      });
      document
        .querySelector("#updateLoc")
        .addEventListener("click", updateLocation);
      document
        .querySelector("#updateLink")
        .addEventListener("click", updateLink);

      document.querySelector("#room").addEventListener("change", changeRoom);

      pwShowHide.forEach((eyeIcon) => {
        eyeIcon.addEventListener("click", () => {
          let pwFields =
            eyeIcon.parentElement.parentElement.querySelectorAll(".password");

          pwFields.forEach((password) => {
            if (password.type === "password") {
              password.type = "text";
              eyeIcon.classList.replace("bx-hide", "bx-show");
              return;
            }
            password.type = "password";
            eyeIcon.classList.replace("bx-show", "bx-hide");
          });
        });
      });

      var map = L.map("map", {
        zoomControl: false,
        renderer: L.canvas(),
      });

      L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
        {
          attribution:
            '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
          maxZoom: 21,
        }
      ).addTo(map);

      var myMarker;

      setInterval(() => {
       console.log("***RELOAD****");
         //submit();
         reloadDataSensor(timeLengthGraph, timespanGraph);
       }, timespanGraph * 60000);

      function submit() {
        console.log("---------");
        console.log("---------");
        console.log("SUBMIT");

        moduleair = document.querySelector("#moduleair").value;
        token = document.querySelector("#token").value;


        $.ajax({
          method: "GET",
          url:
            "https://api.aircarto.fr/capteurs/metadata?capteurType=ModuleAir&capteurID=" +
            moduleair +
            "&token=" +
            token,
        })
          .done(function (data) {
            console.log("Getting data from aircarto API (metadata)");

            console.log(data);
            if (data != null) {
              // Save credentials to localStorage on successful login
              localStorage.setItem("moduleair_id", moduleair);
              localStorage.setItem("moduleair_token", token);

              document.querySelector("#room").value = data[0].room;

              const timestamp_UTC = new Date(data[0].time);
              const timestamp_current = Date.now();

              let difference =
                (timestamp_current - timestamp_UTC) / 1000 / 3600;

              console.log(difference);

              if (difference <= 1) {
                timeLengthGraph = 3;
              }
              if (difference > 1 && difference <= 3) {
                timeLengthGraph = 3;
              }
              if (difference > 3 && difference <= 24) {
                timeLengthGraph = 24;
              }
              if (difference > 24 && difference <= 48) {
                timeLengthGraph = 48;
              }
              if (difference > 48 && difference <= 168) {
                timeLengthGraph = 168;
              }
              if (difference > 168 && difference <= 720) {
                timeLengthGraph = 720;
              }
              if (difference > 720 && difference <= 8760) {
                timeLengthGraph = 8760;
              }

              document.querySelector("#lat").value = data[0].latitude;
              document.querySelector("#lon").value = data[0].longitude;
              if(data[0].link != null){
              document.querySelector("#linkNebuleAir").value = data[0].link.split("-")[1];
              }else{
                document.querySelector("#linkNebuleAir").value = "";
              }

              // const offset = -new Date().getTimezoneOffset() / 60;
              //const  timestamp_local = new Date(timestamp_UTC.setHours(timestamp_UTC.getHours() + offset));

              document.querySelector("#idm").innerText = data[0].sensorId;
              document.querySelector("#timestamp").innerText = timeDateCounter(data[0].time);

              //let wifiLevel = 2 * (parseInt(data[0].wifi_signal) + 100);
              //document.querySelector("#wifilevel").innerText = wifiLevel + " %";

              document.querySelector("#container_form").style.display = "none";
              document.querySelector("#container_graphs").style.display = "block";


              if (
                root1 != undefined &&
                root2 != undefined &&
                root3 != undefined &&
                root4 != undefined
              ) {
                root1.dispose();
                root2.dispose();
                root3.dispose();
                root4.dispose();
              }

              setTimeout(function () {
                am5.ready(function () {
                  root1 = am5.Root.new("chartdiv1");
                  gaugeCreator(root1, data[0], "PM1");

                  root2 = am5.Root.new("chartdiv2");
                  gaugeCreator(root2, data[0], "PM25");

                  root3 = am5.Root.new("chartdiv3");
                  gaugeCreator(root3, data[0], "PM10");

                  root4 = am5.Root.new("chartdiv4");
                  gaugeCreator(root4, data[0], "CO2");
                });
              }, 1000);

              let coordsCenter = [data[0].latitude, data[0].longitude]; // Marseille
              let zoomLevel = 16;

              map.setView(coordsCenter, zoomLevel);

              myMarker = new L.marker([data[0].latitude, data[0].longitude], {
                title: "Coordinates",
                alt: "Coordinates",
                draggable: true,
              })
                .addTo(map)
                .on("dragend", function () {
                  var lat = myMarker.getLatLng().lat.toFixed(8);
                  var lon = myMarker.getLatLng().lng.toFixed(8);
                  var czoom = map.getZoom();
                  if (czoom < 18) {
                    nzoom = czoom + 2;
                  }
                  if (nzoom > 18) {
                    nzoom = 18;
                  }
                  if (czoom != 18) {
                    map.setView([lat, lon], nzoom);
                  } else {
                    map.setView([lat, lon]);
                  }
                  document.getElementById("lat").value = lat;
                  document.getElementById("lon").value = lon;
                  myMarker
                    .bindPopup("Lat " + lat + "<br />Lon " + lon)
                    .openPopup();
                });

              console.log(myMarker);

              let id = moduleair;

              document.getElementById("button1h").innerHTML =
                '<button type="button" onclick="chooseTimeModuleAir(\'' + id + "',1," + timespanGraph + ')" class="time-btn">1h</button>';
              document.getElementById("button3h").innerHTML =
                '<button type="button" onclick="chooseTimeModuleAir(\'' + id + "',3," + timespanGraph + ')" class="time-btn">3h</button>';
              document.getElementById("button24h").innerHTML =
                '<button type="button" onclick="chooseTimeModuleAir(\'' + id + "',24," + timespanGraph + ')" class="time-btn">24h</button>';
              document.getElementById("button48h").innerHTML =
                '<button type="button" onclick="chooseTimeModuleAir(\'' + id + "',48," + timespanGraph + ')" class="time-btn">48h</button>';
              document.getElementById("button1s").innerHTML =
                '<button type="button" onclick="chooseTimeModuleAir(\'' + id + "',168," + timespanGraph + ')" class="time-btn">1 sem</button>';
              document.getElementById("button1m").innerHTML =
                '<button type="button" onclick="chooseTimeModuleAir(\'' + id + "',720," + timespanGraph + ')" class="time-btn">1 mois</button>';
              document.getElementById("button1a").innerHTML =
                '<button type="button" onclick="chooseTimeModuleAir(\'' + id + "',8760," + timespanGraph + ')" class="time-btn" disabled>1 an</button>';
              document.getElementById("button2m").innerHTML =
                '<button type="button" onclick="chooseTimeModuleAir(\'' + id + "'," + timeLengthGraph + ',2)" class="time-btn">2m</button>';
              document.getElementById("button15m").innerHTML =
                '<button type="button" onclick="chooseTimeModuleAir(\'' + id + "'," + timeLengthGraph + ',15)" class="time-btn">15m</button>';
              document.getElementById("button60m").innerHTML =
                '<button type="button" onclick="chooseTimeModuleAir(\'' + id + "'," + timeLengthGraph + ',60)" class="time-btn">1h</button>';
              document.getElementById("button1440m").innerHTML =
                '<button type="button" onclick="chooseTimeModuleAir(\'' + id + "'," + timeLengthGraph + ',1440)" class="time-btn">24h</button>';
              buttonsSwitcher(timeLengthGraph, timespanGraph);

              const end = new Date();
              const end_string = end.toISOString();
              const get_start = end.setHours(end.getHours() - timeLengthGraph);
              const start = new Date(get_start);
              const start_string = start.toISOString();
              console.log(start_string);
              console.log(end_string);

              if (data[0].link != null && data[0].link != "" && data[0].link.includes("nebuleair-")) {
                nebuleair = data[0].link;

                console.log(
                  "https://api.aircarto.fr/capteurs/dataNebuleAir?capteurID=" +
                    data[0].link +
                    "&start=" +
                    start_string +
                    "&end=" +
                    end_string +
                    "&freq=2m"
                );

                $.ajax({
                  method: "GET",
                  url:
                    "https://api.aircarto.fr/capteurs/dataNebuleAir?capteurID=" +
                    data[0].link +
                    "&start=" +
                    start_string +
                    "&end=" +
                    end_string +
                    "&freq=2m",
                })
                  .done(function (data) {
                    console.log("Getting NebuleAir data from aircarto API (data) :");
                    console.log(data);
                    dataNebuleAir = data;
                    if (data == null) {
                      openToast("Pas de donnée NebuleAir sur cet intervalle.");
                    }
                  })
                  .fail(function () {
                    console.log("Error while geting data from Aircarto API");
                  });
              }

              console.log(
                "https://api.aircarto.fr/capteurs/dataModuleAir?capteurID=" +
                  moduleair +
                  "&start=" +
                  start_string +
                  "&end=" +
                  end_string +
                  "&freq=2m&token=" +
                  token
              );

              $.ajax({
                method: "GET",
                url:
                  "https://api.aircarto.fr/capteurs/dataModuleAir?capteurID=" +
                  moduleair +
                  "&start=" +
                  start_string +
                  "&end=" +
                  end_string +
                  "&freq=2m" +
                  "&token=" +
                  token,
              })
                .done(function (data) {
                  console.log("Getting ModuleAir data from aircarto API (data) :");
                  console.log(data);

                  // Dispose old unified chart if exists
                  if (rootUnified != undefined) {
                    rootUnified.dispose();
                  }

                  setTimeout(function () {
                    am5.ready(function () {
                      if (data != null) {
                        // Create unified chart
                        rootUnified = am5.Root.new("unifiedChart");
                        unifiedGraphCreator(
                          rootUnified,
                          data,
                          dataNebuleAir,
                          timespanGraph,
                          data[0].sensorId
                        );
                      } else {
                        openToast(
                          "Pas de donnée sur cet intervalle. Veuillez choisir une période plus longue."
                        );
                      }
                    });
                  }, 1000);
                })
                .fail(function () {
                  console.log("Error while geting data from Aircarto API");
                });
            } else {
              document.querySelector("#moduleair").value = "";
              document.querySelector("#token").value = "";
            }
          })
          .fail(function () {
            console.log("Error while geting data from Aircarto API");
            document.querySelector("#moduleair").value = "";
            document.querySelector("#token").value = "";
          });
      }

      function graphCreator(root, data1, data2, type, timespan, id) {
        let dataMerged;

        if (data2 != null && data2 != undefined){
           dataMerged = data1.concat(data2);
        }else{
          dataMerged = data1;
        }
        
        let data_PM1_moduleair = data1.map(function (e) {
          return { value: e.PM1, date: new Date(e.time).getTime() };
        });
        let data_PM25_moduleair = data1.map(function (e) {
          return { value: e.PM25, date: new Date(e.time).getTime() };
        });
        let data_PM10_moduleair = data1.map(function (e) {
          return { value: e.PM10, date: new Date(e.time).getTime() };
        });

        let data_T_moduleair = data1.map(function (e) {
          return { value: e.TEMP, date: new Date(e.time).getTime() };
        });

        let data_H_moduleair = data1.map(function (e) {
          return { value: e.HUM, date: new Date(e.time).getTime() };
        });

        let data_P_moduleair = data1.map(function (e) {
          return { value: e.PRESS, date: new Date(e.time).getTime() };
        });

        let data_COV_moduleair = data1.map(function (e) {
          return { value: e.COV, date: new Date(e.time).getTime() };
        });

        let data_CO2_moduleair = data1.map(function (e) {
          return { value: e.CO2, date: new Date(e.time).getTime() };
        });

        let data_PM1_nebuleair = null;
        let data_PM25_nebuleair = null;
        let data_PM10_nebuleair = null;
        let data_T_nebuleair = null;
        let data_H_nebuleair = null;
        let data_P_nebuleair = null;
        let data_COV_nebuleair = null;

        if (data2 != null && data2 != undefined) {
          data_PM1_nebuleair = data2.map(function (e) {
            return { value: e.PM1, date: new Date(e.time).getTime() };
          });
          data_PM25_nebuleair = data2.map(function (e) {
            return { value: e.PM25, date: new Date(e.time).getTime() };
          });
          data_PM10_nebuleair = data2.map(function (e) {
            return { value: e.PM10, date: new Date(e.time).getTime() };
          });

          data_T_nebuleair = data2.map(function (e) {
            return { value: e.TEMP, date: new Date(e.time).getTime() };
          });

          data_H_nebuleair = data2.map(function (e) {
            return { value: e.HUM, date: new Date(e.time).getTime() };
          });

          data_P_nebuleair = data2.map(function (e) {
            return { value: e.PRESS, date: new Date(e.time).getTime() };
          });

          data_COV_nebuleair = data2.map(function (e) {
            return { value: e.COV, date: new Date(e.time).getTime() };
          });
        }

        let idTitre = id;

        let chartTitleText = "";
        chartTitleText += "ModuleAir-" + idTitre + ", ";

        switch (timespan) {
          case 2:
            chartTitleText += "mesures à 2 minutes, ";
            break;
          case 15:
            chartTitleText += "moyennes quart-horaires, ";
            break;
          case 60:
            chartTitleText += "moyennes horaires, ";
            break;
          case 1440:
            chartTitleText += "moyennes journalières, ";
            break;
        }

        root.numberFormatter.set("numberFormat", "####");

        if (type == "PM") {
          chartTitleText += "µg/m3";

          // Set themes
          // https://www.amcharts.com/docs/v5/concepts/themes/
          root.setThemes([am5themes_Animated.new(root)]);

          // Create chart
          // https://www.amcharts.com/docs/v5/charts/xy-chart/
          let chart = root.container.children.push(
            am5xy.XYChart.new(root, {
              panX: true,
              panY: true,
              wheelX: "panX",
              wheelY: "zoomX",
              maxTooltipDistance: 0,
              pinchZoomX: true,
            })
          );


          chart.get("colors").set("colors", [
            am5.color(0xf44336),
            am5.color(0x8fce00),
            am5.color(0x2986cc),
            am5.color(0xffd966),
            am5.color(0x814c9e),
            am5.color(0xf48686)
          ]);

          // Create axes
          // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
          let xAxis = chart.xAxes.push(
            am5xy.DateAxis.new(root, {
              maxDeviation: 0.2,
              baseInterval: {
                timeUnit: "minute",
                count: 1,
              },
              renderer: am5xy.AxisRendererX.new(root, {}),
              tooltip: am5.Tooltip.new(root, {}),
            })
          );

          let yAxis = chart.yAxes.push(
            am5xy.ValueAxis.new(root, {
              renderer: am5xy.AxisRendererY.new(root, {}),
            })
          );

          let series_PM1_moduleair = chart.series.push(
            am5xy.LineSeries.new(root, {
              name: "PM1 int.",
              xAxis: xAxis,
              yAxis: yAxis,
              valueYField: "value",
              valueXField: "date",
              legendValueText: "{valueY}",
              tooltip: am5.Tooltip.new(root, {
                pointerOrientation: "horizontal",
                labelText: "{valueY}",
              }),
            })
          );

          series_PM1_moduleair.data.setAll(data_PM1_moduleair);
          series_PM1_moduleair.appear();

          console.log(data_PM1_nebuleair);
          if (data_PM1_nebuleair != null) {
            let series_PM1_nebuleair = chart.series.push(
              am5xy.LineSeries.new(root, {
                name: "PM1 ext.",
                xAxis: xAxis,
                yAxis: yAxis,
                valueYField: "value",
                valueXField: "date",
                legendValueText: "{valueY}",
                tooltip: am5.Tooltip.new(root, {
                  pointerOrientation: "horizontal",
                  labelText: "{valueY}",
                }),
              })
            );

            series_PM1_nebuleair.data.setAll(data_PM1_nebuleair);
            series_PM1_nebuleair.appear();
          }



          let series_PM25_moduleair = chart.series.push(
            am5xy.LineSeries.new(root, {
              name: "PM2.5 int.",
              // connect : false,
              xAxis: xAxis,
              yAxis: yAxis,
              valueYField: "value",
              valueXField: "date",
              legendValueText: "{valueY}",
              tooltip: am5.Tooltip.new(root, {
                pointerOrientation: "horizontal",
                labelText: "{valueY}",
              }),
            })
          );

          series_PM25_moduleair.data.setAll(data_PM25_moduleair);
          series_PM25_moduleair.appear();

          if (data_PM25_nebuleair != null) {
            let series_PM25_nebuleair = chart.series.push(
              am5xy.LineSeries.new(root, {
                name: "PM2.5 ext.",
                xAxis: xAxis,
                yAxis: yAxis,
                valueYField: "value",
                valueXField: "date",
                legendValueText: "{valueY}",
                tooltip: am5.Tooltip.new(root, {
                  pointerOrientation: "horizontal",
                  labelText: "{valueY}",
                }),
              })
            );

            series_PM25_nebuleair.data.setAll(data_PM25_nebuleair);
            series_PM25_nebuleair.appear();
          }

          let series_PM10_moduleair = chart.series.push(
            am5xy.LineSeries.new(root, {
              name: "PM10 int.",
              // connect : false,
              xAxis: xAxis,
              yAxis: yAxis,
              valueYField: "value",
              valueXField: "date",
              legendValueText: "{valueY}",
              tooltip: am5.Tooltip.new(root, {
                pointerOrientation: "horizontal",
                labelText: "{valueY}",
              }),
            })
          );

          series_PM10_moduleair.data.setAll(data_PM10_moduleair);
          series_PM10_moduleair.appear();

          if (data_PM10_nebuleair != null) {
            let series_PM10_nebuleair = chart.series.push(
              am5xy.LineSeries.new(root, {
                name: "PM10 ext.",
                xAxis: xAxis,
                yAxis: yAxis,
                valueYField: "value",
                valueXField: "date",
                legendValueText: "{valueY}",
                tooltip: am5.Tooltip.new(root, {
                  pointerOrientation: "horizontal",
                  labelText: "{valueY}",
                }),
              })
            );

            series_PM10_nebuleair.data.setAll(data_PM10_nebuleair);
            series_PM10_nebuleair.appear();
          }

          // Add cursor
          // https://www.amcharts.com/docs/v5/charts/xy-chart/cursor/
          var cursor = chart.set(
            "cursor",
            am5xy.XYCursor.new(root, {
              behavior: "zoomX",
              xAxis: xAxis,
              snapToSeriesBy: "!x"
            })
          );
          cursor.lineX.set("visible", true);
          cursor.lineY.set("visible", false);

          var legend = chart.bottomAxesContainer.children.push(
            am5.Legend.new(root, {
              width: 800,
              height: am5.percent(20),
              layout: root.horizontalLayout,
            })
          );

          // When legend item container is hovered, dim all the series except the hovered one
          legend.itemContainers.template.events.on("pointerover", function (e) {
            var itemContainer = e.target;

            // As series list is data of a legend, dataContext is series
            var series = itemContainer.dataItem.dataContext;

            chart.series.each(function (chartSeries) {
              if (chartSeries != series) {
                chartSeries.strokes.template.setAll({
                  strokeOpacity: 0.15,
                  stroke: am5.color(0x000000),
                });
              } else {
                chartSeries.strokes.template.setAll({
                  strokeWidth: 3,
                });
              }
            });
          });

          // When legend item container is unhovered, make all series as they are
          legend.itemContainers.template.events.on("pointerout", function (e) {
            var itemContainer = e.target;
            var series = itemContainer.dataItem.dataContext;

            chart.series.each(function (chartSeries) {
              chartSeries.strokes.template.setAll({
                strokeOpacity: 1,
                strokeWidth: 1,
                stroke: chartSeries.get("fill"),
              });
            });
          });

          legend.itemContainers.template.set("width", am5.p100);
          legend.valueLabels.template.setAll({
            width: am5.p100,
            textAlign: "right",
          });

          legend.valueLabels.template.set("forceHidden", true);
          // It's is important to set legend data after all the events are set on template, otherwise events won't be copied
          legend.data.setAll(chart.series.values);

          chart.children.unshift(
            am5.Label.new(root, {
              text: chartTitleText,
              fontSize: 14,
              textAlign: "center",
              x: am5.percent(50),
              centerX: am5.percent(50),
            })
          );

          var exporting = am5plugins_exporting.Exporting.new(root, {
            menu: am5plugins_exporting.ExportingMenu.new(root, {}),
            dataSource: dataMerged,
          });

          // Make stuff animate on load
          // https://www.amcharts.com/docs/v5/concepts/animations/
          chart.appear(1000, 100);
        }

        if (type == "THP") {
          chartTitleText += "°C, %, hPa";

          // Set themes
          // https://www.amcharts.com/docs/v5/concepts/themes/
          root.setThemes([am5themes_Animated.new(root)]);

          // Create chart
          // https://www.amcharts.com/docs/v5/charts/xy-chart/
          let chart = root.container.children.push(
            am5xy.XYChart.new(root, {
              panX: true,
              panY: true,
              wheelX: "panX",
              wheelY: "zoomX",
              maxTooltipDistance: 0,
              pinchZoomX: true,
            })
          );


          chart.get("colors").set("colors", [
            am5.color(0xf44336),
            am5.color(0x8fce00),
            am5.color(0x2986cc),
            am5.color(0xffd966),
            am5.color(0x814c9e),
            am5.color(0xf48686)
          ]);

          // Create axes
          // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
          let xAxis = chart.xAxes.push(
            am5xy.DateAxis.new(root, {
              maxDeviation: 0.2,
              baseInterval: {
                timeUnit: "minute",
                count: 1,
              },
              renderer: am5xy.AxisRendererX.new(root, {}),
              tooltip: am5.Tooltip.new(root, {}),
            })
          );

          let yAxisT = chart.yAxes.push(
            am5xy.ValueAxis.new(root, {
              renderer: am5xy.AxisRendererY.new(root, {}),
            })
          );

          let yAxisH = chart.yAxes.push(
            am5xy.ValueAxis.new(root, {
              renderer: am5xy.AxisRendererY.new(root, {}),
            })
          );

          let yAxisP = chart.yAxes.push(
            am5xy.ValueAxis.new(root, {
              renderer: am5xy.AxisRendererY.new(root, {}),
            })
          );

          let series_T_moduleair = chart.series.push(
            am5xy.LineSeries.new(root, {
              name: "Temp. int.",
              xAxis: xAxis,
              yAxis: yAxisT,
              valueYField: "value",
              valueXField: "date",
              legendValueText: "{valueY}",
              tooltip: am5.Tooltip.new(root, {
                pointerOrientation: "horizontal",
                labelText: "{valueY}",
              }),
            })
          );

          series_T_moduleair.data.setAll(data_T_moduleair);
          series_T_moduleair.appear();

          if (data_T_nebuleair != null) {
            let series_T_nebuleair = chart.series.push(
              am5xy.LineSeries.new(root, {
                name: "Temp. ext.",
                xAxis: xAxis,
                yAxis: yAxisT,
                valueYField: "value",
                valueXField: "date",
                legendValueText: "{valueY}",
                tooltip: am5.Tooltip.new(root, {
                  pointerOrientation: "horizontal",
                  labelText: "{valueY}",
                }),
              })
            );

            series_T_nebuleair.data.setAll(data_T_nebuleair);
            series_T_nebuleair.appear();
          }

          let series_H_moduleair = chart.series.push(
            am5xy.LineSeries.new(root, {
              name: "Hum. rel. int.",
              xAxis: xAxis,
              yAxis: yAxisH,
              valueYField: "value",
              valueXField: "date",
              legendValueText: "{valueY}",
              tooltip: am5.Tooltip.new(root, {
                pointerOrientation: "horizontal",
                labelText: "{valueY}",
              }),
            })
          );

          series_H_moduleair.data.setAll(data_H_moduleair);
          series_H_moduleair.appear();

          if (data_H_nebuleair != null) {
            let series_H_nebuleair = chart.series.push(
              am5xy.LineSeries.new(root, {
                name: "Hum. rel. ext.",
                xAxis: xAxis,
                yAxis: yAxisH,
                valueYField: "value",
                valueXField: "date",
                legendValueText: "{valueY}",
                tooltip: am5.Tooltip.new(root, {
                  pointerOrientation: "horizontal",
                  labelText: "{valueY}",
                }),
              })
            );

            series_H_nebuleair.data.setAll(data_H_nebuleair);
            series_H_nebuleair.appear();
          }

          let series_P_moduleair = chart.series.push(
            am5xy.LineSeries.new(root, {
              name: "Press. int.",
              xAxis: xAxis,
              yAxis: yAxisP,
              valueYField: "value",
              valueXField: "date",
              legendValueText: "{valueY}",
              tooltip: am5.Tooltip.new(root, {
                pointerOrientation: "horizontal",
                labelText: "{valueY}",
              }),
            })
          );

          series_P_moduleair.data.setAll(data_P_moduleair);
          series_P_moduleair.appear();

          if (data_P_nebuleair != null) {
            let series_P_nebuleair = chart.series.push(
              am5xy.LineSeries.new(root, {
                name: "Press. ext.",
                xAxis: xAxis,
                yAxis: yAxisP,
                valueYField: "value",
                valueXField: "date",
                legendValueText: "{valueY}",
                tooltip: am5.Tooltip.new(root, {
                  pointerOrientation: "horizontal",
                  labelText: "{valueY}",
                }),
              })
            );

            series_P_nebuleair.data.setAll(data_P_nebuleair);
            series_P_nebuleair.appear();
          }

          // Add cursor
          // https://www.amcharts.com/docs/v5/charts/xy-chart/cursor/
          var cursor = chart.set(
            "cursor",
            am5xy.XYCursor.new(root, {
              behavior: "zoomX",
              xAxis: xAxis,
              snapToSeriesBy: "!x"
            })
          );
          cursor.lineX.set("visible", true);
          cursor.lineY.set("visible", false);

          var legend = chart.bottomAxesContainer.children.push(
            am5.Legend.new(root, {
              width: 800,
              height: am5.percent(20),
              layout: root.horizontalLayout,
            })
          );

          // When legend item container is hovered, dim all the series except the hovered one
          legend.itemContainers.template.events.on("pointerover", function (e) {
            var itemContainer = e.target;

            // As series list is data of a legend, dataContext is series
            var series = itemContainer.dataItem.dataContext;

            chart.series.each(function (chartSeries) {
              if (chartSeries != series) {
                chartSeries.strokes.template.setAll({
                  strokeOpacity: 0.15,
                  stroke: am5.color(0x000000),
                });
              } else {
                chartSeries.strokes.template.setAll({
                  strokeWidth: 3,
                });
              }
            });
          });

          // When legend item container is unhovered, make all series as they are
          legend.itemContainers.template.events.on("pointerout", function (e) {
            var itemContainer = e.target;
            var series = itemContainer.dataItem.dataContext;

            chart.series.each(function (chartSeries) {
              chartSeries.strokes.template.setAll({
                strokeOpacity: 1,
                strokeWidth: 1,
                stroke: chartSeries.get("fill"),
              });
            });
          });

          legend.itemContainers.template.set("width", am5.p100);
          legend.valueLabels.template.setAll({
            width: am5.p100,
            textAlign: "right",
          });

          legend.valueLabels.template.set("forceHidden", true);

          // It's is important to set legend data after all the events are set on template, otherwise events won't be copied
          legend.data.setAll(chart.series.values);

          chart.children.unshift(
            am5.Label.new(root, {
              text: chartTitleText,
              fontSize: 14,
              textAlign: "center",
              x: am5.percent(50),
              centerX: am5.percent(50),
            })
          );

          var exporting = am5plugins_exporting.Exporting.new(root, {
            menu: am5plugins_exporting.ExportingMenu.new(root, {}),
            dataSource: dataMerged,
          });

          // Make stuff animate on load
          // https://www.amcharts.com/docs/v5/concepts/animations/
          chart.appear(1000, 100);
        }

        if (type == "COV") {
          chartTitleText += "ppm";

          // Set themes
          // https://www.amcharts.com/docs/v5/concepts/themes/
          root.setThemes([am5themes_Animated.new(root)]);

          // Create chart
          // https://www.amcharts.com/docs/v5/charts/xy-chart/
          let chart = root.container.children.push(
            am5xy.XYChart.new(root, {
              panX: true,
              panY: true,
              wheelX: "panX",
              wheelY: "zoomX",
              maxTooltipDistance: 0,
              pinchZoomX: true,
            })
          );

          chart.get("colors").set("colors", [
            am5.color(0xf44336),
            am5.color(0x8fce00),
            am5.color(0x2986cc),
            am5.color(0xffd966),
            am5.color(0x814c9e),
            am5.color(0xf48686)
          ]);

          // Create axes
          // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
          let xAxis = chart.xAxes.push(
            am5xy.DateAxis.new(root, {
              maxDeviation: 0.2,
              baseInterval: {
                timeUnit: "minute",
                count: 1,
              },
              renderer: am5xy.AxisRendererX.new(root, {}),
              tooltip: am5.Tooltip.new(root, {}),
            })
          );

          let yAxis = chart.yAxes.push(
            am5xy.ValueAxis.new(root, {
              renderer: am5xy.AxisRendererY.new(root, {}),
            })
          );

          let series_COV_moduleair = chart.series.push(
            am5xy.LineSeries.new(root, {
              name: "COV int.",
              xAxis: xAxis,
              yAxis: yAxis,
              valueYField: "value",
              valueXField: "date",
              legendValueText: "{valueY}",
              tooltip: am5.Tooltip.new(root, {
                pointerOrientation: "horizontal",
                labelText: "{valueY}",
              }),
            })
          );

          series_COV_moduleair.data.setAll(data_COV_moduleair);
          series_COV_moduleair.appear();

          if (data_COV_nebuleair != null) {
            let series_COV_nebuleair = chart.series.push(
              am5xy.LineSeries.new(root, {
                name: "COV ext.",
                xAxis: xAxis,
                yAxis: yAxis,
                valueYField: "value",
                valueXField: "date",
                legendValueText: "{valueY}",
                tooltip: am5.Tooltip.new(root, {
                  pointerOrientation: "horizontal",
                  labelText: "{valueY}",
                }),
              })
            );

            series_COV_nebuleair.data.setAll(data_COV_nebuleair);
            series_COV_nebuleair.appear();
          }

          // Add cursor
          // https://www.amcharts.com/docs/v5/charts/xy-chart/cursor/
          var cursor = chart.set(
            "cursor",
            am5xy.XYCursor.new(root, {
              behavior: "zoomX",
              xAxis: xAxis,
              snapToSeriesBy: "!x"
            })
          );
          cursor.lineX.set("visible", true);
          cursor.lineY.set("visible", false);

          var legend = chart.bottomAxesContainer.children.push(
            am5.Legend.new(root, {
              width: 800,
              height: am5.percent(20),
              layout: root.horizontalLayout,
            })
          );

          // When legend item container is hovered, dim all the series except the hovered one
          legend.itemContainers.template.events.on("pointerover", function (e) {
            var itemContainer = e.target;

            // As series list is data of a legend, dataContext is series
            var series = itemContainer.dataItem.dataContext;

            chart.series.each(function (chartSeries) {
              if (chartSeries != series) {
                chartSeries.strokes.template.setAll({
                  strokeOpacity: 0.15,
                  stroke: am5.color(0x000000),
                });
              } else {
                chartSeries.strokes.template.setAll({
                  strokeWidth: 3,
                });
              }
            });
          });

          // When legend item container is unhovered, make all series as they are
          legend.itemContainers.template.events.on("pointerout", function (e) {
            var itemContainer = e.target;
            var series = itemContainer.dataItem.dataContext;

            chart.series.each(function (chartSeries) {
              chartSeries.strokes.template.setAll({
                strokeOpacity: 1,
                strokeWidth: 1,
                stroke: chartSeries.get("fill"),
              });
            });
          });

          legend.itemContainers.template.set("width", am5.p100);
          legend.valueLabels.template.setAll({
            width: am5.p100,
            textAlign: "right",
          });

          legend.valueLabels.template.set("forceHidden", true);
          // It's is important to set legend data after all the events are set on template, otherwise events won't be copied
          legend.data.setAll(chart.series.values);

          chart.children.unshift(
            am5.Label.new(root, {
              text: chartTitleText,
              fontSize: 14,
              textAlign: "center",
              x: am5.percent(50),
              centerX: am5.percent(50),
            })
          );

          var exporting = am5plugins_exporting.Exporting.new(root, {
            menu: am5plugins_exporting.ExportingMenu.new(root, {}),
            dataSource: dataMerged,
          });

          // Make stuff animate on load
          // https://www.amcharts.com/docs/v5/concepts/animations/
          chart.appear(1000, 100);
        }

        if (type == "CO2") {
          chartTitleText += "ppm";

          // Set themes
          // https://www.amcharts.com/docs/v5/concepts/themes/
          root.setThemes([am5themes_Animated.new(root)]);

          // Create chart
          // https://www.amcharts.com/docs/v5/charts/xy-chart/
          let chart = root.container.children.push(
            am5xy.XYChart.new(root, {
              panX: true,
              panY: true,
              wheelX: "panX",
              wheelY: "zoomX",
              maxTooltipDistance: 0,
              pinchZoomX: true,
            })
          );

          chart.get("colors").set("colors", [
            am5.color(0xf44336),
            am5.color(0x8fce00),
            am5.color(0x2986cc),
            am5.color(0xffd966),
            am5.color(0x814c9e),
            am5.color(0xf48686)
          ]);

          // Create axes
          // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
          let xAxis = chart.xAxes.push(
            am5xy.DateAxis.new(root, {
              maxDeviation: 0.2,
              baseInterval: {
                timeUnit: "minute",
                count: 1,
              },
              renderer: am5xy.AxisRendererX.new(root, {}),
              tooltip: am5.Tooltip.new(root, {}),
            })
          );

          let yAxis = chart.yAxes.push(
            am5xy.ValueAxis.new(root, {
              renderer: am5xy.AxisRendererY.new(root, {}),
            })
          );

          let series_CO2 = chart.series.push(
            am5xy.LineSeries.new(root, {
              name: "CO₂ int.",
              xAxis: xAxis,
              yAxis: yAxis,
              valueYField: "value",
              valueXField: "date",
              legendValueText: "{valueY}",
              tooltip: am5.Tooltip.new(root, {
                pointerOrientation: "horizontal",
                labelText: "{valueY}",
              }),
            })
          );

          series_CO2.data.setAll(data_CO2_moduleair);
          series_CO2.appear();

          // Add cursor
          // https://www.amcharts.com/docs/v5/charts/xy-chart/cursor/
          var cursor = chart.set(
            "cursor",
            am5xy.XYCursor.new(root, {
              behavior: "zoomX",
              xAxis: xAxis,
              snapToSeriesBy: "!x"
            })
          );
          cursor.lineX.set("visible", true);
          cursor.lineY.set("visible", false);

          var legend = chart.bottomAxesContainer.children.push(
            am5.Legend.new(root, {
              width: 800,
              height: am5.percent(20),
              layout: root.horizontalLayout,
            })
          );

          // When legend item container is hovered, dim all the series except the hovered one
          legend.itemContainers.template.events.on("pointerover", function (e) {
            var itemContainer = e.target;

            // As series list is data of a legend, dataContext is series
            var series = itemContainer.dataItem.dataContext;

            chart.series.each(function (chartSeries) {
              if (chartSeries != series) {
                chartSeries.strokes.template.setAll({
                  strokeOpacity: 0.15,
                  stroke: am5.color(0x000000),
                });
              } else {
                chartSeries.strokes.template.setAll({
                  strokeWidth: 3,
                });
              }
            });
          });

          // When legend item container is unhovered, make all series as they are
          legend.itemContainers.template.events.on("pointerout", function (e) {
            var itemContainer = e.target;
            var series = itemContainer.dataItem.dataContext;

            chart.series.each(function (chartSeries) {
              chartSeries.strokes.template.setAll({
                strokeOpacity: 1,
                strokeWidth: 1,
                stroke: chartSeries.get("fill"),
              });
            });
          });

          legend.itemContainers.template.set("width", am5.p100);
          legend.valueLabels.template.setAll({
            width: am5.p100,
            textAlign: "right",
          });

          legend.valueLabels.template.set("forceHidden", true);
          // It's is important to set legend data after all the events are set on template, otherwise events won't be copied
          legend.data.setAll(chart.series.values);

          chart.children.unshift(
            am5.Label.new(root, {
              text: chartTitleText,
              fontSize: 14,
              textAlign: "center",
              x: am5.percent(50),
              centerX: am5.percent(50),
            })
          );

          var exporting = am5plugins_exporting.Exporting.new(root, {
            menu: am5plugins_exporting.ExportingMenu.new(root, {}),
            dataSource: dataMerged,
          });

          // Make stuff animate on load
          // https://www.amcharts.com/docs/v5/concepts/animations/
          chart.appear(1000, 100);
        }
      }

      // Unified chart creator - single chart with all series
      function unifiedGraphCreator(root, data1, data2, timespan, id) {
        let dataMerged;
        if (data2 != null && data2 != undefined) {
          dataMerged = data1.concat(data2);
        } else {
          dataMerged = data1;
        }

        // Prepare data for each pollutant (no pressure)
        let data_PM1_int = data1.map(e => ({ value: e.PM1, date: new Date(e.time).getTime() }));
        let data_PM25_int = data1.map(e => ({ value: e.PM25, date: new Date(e.time).getTime() }));
        let data_PM10_int = data1.map(e => ({ value: e.PM10, date: new Date(e.time).getTime() }));
        let data_TEMP_int = data1.map(e => ({ value: e.TEMP, date: new Date(e.time).getTime() }));
        let data_HUM_int = data1.map(e => ({ value: e.HUM, date: new Date(e.time).getTime() }));
        let data_COV_int = data1.map(e => ({ value: e.COV, date: new Date(e.time).getTime() }));
        let data_CO2_int = data1.map(e => ({ value: e.CO2, date: new Date(e.time).getTime() }));

        let data_PM1_ext = null, data_PM25_ext = null, data_PM10_ext = null;
        let data_TEMP_ext = null, data_HUM_ext = null;
        let data_COV_ext = null;

        if (data2 != null && data2 != undefined) {
          data_PM1_ext = data2.map(e => ({ value: e.PM1, date: new Date(e.time).getTime() }));
          data_PM25_ext = data2.map(e => ({ value: e.PM25, date: new Date(e.time).getTime() }));
          data_PM10_ext = data2.map(e => ({ value: e.PM10, date: new Date(e.time).getTime() }));
          data_TEMP_ext = data2.map(e => ({ value: e.TEMP, date: new Date(e.time).getTime() }));
          data_HUM_ext = data2.map(e => ({ value: e.HUM, date: new Date(e.time).getTime() }));
          data_COV_ext = data2.map(e => ({ value: e.COV, date: new Date(e.time).getTime() }));
        }

        // Build chart title
        let chartTitleText = "ModuleAir-" + id + ", ";
        switch (timespan) {
          case 2: chartTitleText += "mesures à 2 minutes"; break;
          case 15: chartTitleText += "moyennes quart-horaires"; break;
          case 60: chartTitleText += "moyennes horaires"; break;
          case 1440: chartTitleText += "moyennes journalières"; break;
        }

        root.numberFormatter.set("numberFormat", "#.#");
        root.setThemes([am5themes_Animated.new(root)]);

        // Create chart
        unifiedChart = root.container.children.push(
          am5xy.XYChart.new(root, {
            panX: true,
            panY: true,
            wheelX: "panX",
            wheelY: "zoomX",
            maxTooltipDistance: 0,
            pinchZoomX: true,
            layout: root.verticalLayout
          })
        );

        // Create X axis (time)
        let xAxis = unifiedChart.xAxes.push(
          am5xy.DateAxis.new(root, {
            maxDeviation: 0.2,
            baseInterval: { timeUnit: "minute", count: 1 },
            renderer: am5xy.AxisRendererX.new(root, {}),
            tooltip: am5.Tooltip.new(root, {}),
          })
        );

        // Colors for each pollutant - PM in green gradient
        const colors = {
          PM1: am5.color(0x2d6a4f),
          PM25: am5.color(0x40916c),
          PM10: am5.color(0x74c69d),
          TEMP: am5.color(0xff6b6b),
          HUM: am5.color(0x4ecdc4),
          COV: am5.color(0xf39c12),
          CO2: am5.color(0xe74c3c)
        };

        // ========== CREATE MULTIPLE Y-AXES ==========

        // LEFT SIDE AXES
        // Y-Axis for PM (µg/m³) - Left, first
        let yAxisPM = unifiedChart.yAxes.push(
          am5xy.ValueAxis.new(root, {
            renderer: am5xy.AxisRendererY.new(root, {}),
            min: 0,
          })
        );
        yAxisPM.children.unshift(am5.Label.new(root, {
          text: "PM (µg/m³)",
          rotation: -90,
          y: am5.p50,
          centerX: am5.p50,
          fill: colors.PM25,
          fontSize: 12,
          fontWeight: "500"
        }));

        // Y-Axis for Temperature (°C) - Left, second
        let yAxisTemp = unifiedChart.yAxes.push(
          am5xy.ValueAxis.new(root, {
            renderer: am5xy.AxisRendererY.new(root, {
              opposite: false
            }),
          })
        );
        yAxisTemp.children.unshift(am5.Label.new(root, {
          text: "Temp (°C)",
          rotation: -90,
          y: am5.p50,
          centerX: am5.p50,
          fill: colors.TEMP,
          fontSize: 12,
          fontWeight: "500"
        }));
        yAxisTemp.get("renderer").grid.template.set("forceHidden", true);

        // RIGHT SIDE AXES
        // Y-Axis for CO2 (ppm) - Right, first
        let yAxisCO2 = unifiedChart.yAxes.push(
          am5xy.ValueAxis.new(root, {
            renderer: am5xy.AxisRendererY.new(root, {
              opposite: true
            }),
            min: 400,
          })
        );
        yAxisCO2.children.push(am5.Label.new(root, {
          text: "CO₂ (ppm)",
          rotation: 90,
          y: am5.p50,
          centerX: am5.p50,
          fill: colors.CO2,
          fontSize: 12,
          fontWeight: "500"
        }));
        yAxisCO2.get("renderer").grid.template.set("forceHidden", true);

        // Y-Axis for Humidity (%) - Right, second
        let yAxisHum = unifiedChart.yAxes.push(
          am5xy.ValueAxis.new(root, {
            renderer: am5xy.AxisRendererY.new(root, {
              opposite: true
            }),
            min: 0,
            max: 100,
          })
        );
        yAxisHum.children.push(am5.Label.new(root, {
          text: "Hum (%)",
          rotation: 90,
          y: am5.p50,
          centerX: am5.p50,
          fill: colors.HUM,
          fontSize: 12,
          fontWeight: "500"
        }));
        yAxisHum.get("renderer").grid.template.set("forceHidden", true);

        // Y-Axis for COV (ppb) - Right, third
        let yAxisCOV = unifiedChart.yAxes.push(
          am5xy.ValueAxis.new(root, {
            renderer: am5xy.AxisRendererY.new(root, {
              opposite: true
            }),
            min: 0,
          })
        );
        yAxisCOV.children.push(am5.Label.new(root, {
          text: "COV (ppb)",
          rotation: 90,
          y: am5.p50,
          centerX: am5.p50,
          fill: colors.COV,
          fontSize: 12,
          fontWeight: "500"
        }));
        yAxisCOV.get("renderer").grid.template.set("forceHidden", true);

        // ========== HELPER FUNCTION TO CREATE SERIES ==========
        function createSeries(name, data, color, yAxis, isDashed, unit, pollutantKey) {
          // Check if this series should be visible initially
          const shouldBeVisible = seriesVisibility[pollutantKey];

          let series = unifiedChart.series.push(
            am5xy.LineSeries.new(root, {
              name: name,
              xAxis: xAxis,
              yAxis: yAxis,
              valueYField: "value",
              valueXField: "date",
              stroke: color,
              fill: color,
              legendValueText: "{valueY}",
              visible: shouldBeVisible,
              tooltip: am5.Tooltip.new(root, {
                pointerOrientation: "horizontal",
                labelText: "{name}: {valueY} " + unit,
              }),
            })
          );

          if (isDashed) {
            series.strokes.template.setAll({
              strokeDasharray: [5, 3],
              strokeOpacity: 0.7
            });
          }

          series.data.setAll(data);

          // Only animate if visible
          if (shouldBeVisible) {
            series.appear();
          } else {
            series.hide(0); // Hide immediately without animation
          }

          return series;
        }

        // ========== CREATE ALL SERIES ==========
        allSeries = {};

        // PM series (on yAxisPM) - µg/m³
        allSeries.PM1_int = createSeries("PM1 int.", data_PM1_int, colors.PM1, yAxisPM, false, "µg/m³", "PM1");
        allSeries.PM25_int = createSeries("PM2.5 int.", data_PM25_int, colors.PM25, yAxisPM, false, "µg/m³", "PM25");
        allSeries.PM10_int = createSeries("PM10 int.", data_PM10_int, colors.PM10, yAxisPM, false, "µg/m³", "PM10");

        // Temperature series (on yAxisTemp) - °C
        allSeries.TEMP_int = createSeries("Temp. int.", data_TEMP_int, colors.TEMP, yAxisTemp, false, "°C", "TEMP");

        // Humidity series (on yAxisHum) - %
        allSeries.HUM_int = createSeries("Hum. int.", data_HUM_int, colors.HUM, yAxisHum, false, "%", "HUM");

        // COV series (on yAxisCOV) - ppb
        allSeries.COV_int = createSeries("COV int.", data_COV_int, colors.COV, yAxisCOV, false, "ppb", "COV");

        // CO2 series (on yAxisCO2) - ppm
        allSeries.CO2_int = createSeries("CO₂ int.", data_CO2_int, colors.CO2, yAxisCO2, false, "ppm", "CO2");

        // Exterior series (dashed lines) - only if NebuleAir data exists
        if (data2 != null && data2 != undefined) {
          allSeries.PM1_ext = createSeries("PM1 ext.", data_PM1_ext, colors.PM1, yAxisPM, true, "µg/m³", "PM1");
          allSeries.PM25_ext = createSeries("PM2.5 ext.", data_PM25_ext, colors.PM25, yAxisPM, true, "µg/m³", "PM25");
          allSeries.PM10_ext = createSeries("PM10 ext.", data_PM10_ext, colors.PM10, yAxisPM, true, "µg/m³", "PM10");
          allSeries.TEMP_ext = createSeries("Temp. ext.", data_TEMP_ext, colors.TEMP, yAxisTemp, true, "°C", "TEMP");
          allSeries.HUM_ext = createSeries("Hum. ext.", data_HUM_ext, colors.HUM, yAxisHum, true, "%", "HUM");
          allSeries.COV_ext = createSeries("COV ext.", data_COV_ext, colors.COV, yAxisCOV, true, "ppb", "COV");
        }

        // Store axes references globally for visibility toggle
        allAxes = {
          PM: yAxisPM,
          TEMP: yAxisTemp,
          HUM: yAxisHum,
          COV: yAxisCOV,
          CO2: yAxisCO2
        };

        // Hide axes that shouldn't be visible initially
        const pmVisible = seriesVisibility.PM1 || seriesVisibility.PM25 || seriesVisibility.PM10;
        if (!pmVisible) yAxisPM.hide(0);
        if (!seriesVisibility.TEMP) yAxisTemp.hide(0);
        if (!seriesVisibility.HUM) yAxisHum.hide(0);
        if (!seriesVisibility.COV) yAxisCOV.hide(0);
        if (!seriesVisibility.CO2) yAxisCO2.hide(0);

        // Apply initial visibility based on toggle states
        applySeriesVisibility();

        // Add cursor
        var cursor = unifiedChart.set(
          "cursor",
          am5xy.XYCursor.new(root, {
            behavior: "zoomX",
            xAxis: xAxis,
            snapToSeriesBy: "!x"
          })
        );
        cursor.lineX.set("visible", true);
        cursor.lineY.set("visible", false);

        // Add legend
        var legend = unifiedChart.children.push(
          am5.Legend.new(root, {
            centerX: am5.percent(50),
            x: am5.percent(50),
            layout: root.horizontalLayout,
            marginTop: 15,
          })
        );

        legend.itemContainers.template.events.on("pointerover", function (e) {
          var series = e.target.dataItem.dataContext;
          unifiedChart.series.each(function (chartSeries) {
            if (chartSeries != series) {
              chartSeries.strokes.template.setAll({ strokeOpacity: 0.15 });
            } else {
              chartSeries.strokes.template.setAll({ strokeWidth: 3 });
            }
          });
        });

        legend.itemContainers.template.events.on("pointerout", function (e) {
          unifiedChart.series.each(function (chartSeries) {
            chartSeries.strokes.template.setAll({
              strokeOpacity: 1,
              strokeWidth: 1,
            });
          });
        });

        legend.valueLabels.template.set("forceHidden", true);
        legend.data.setAll(unifiedChart.series.values);

        // Add title
        unifiedChart.children.unshift(
          am5.Label.new(root, {
            text: chartTitleText,
            fontSize: 14,
            fontWeight: "500",
            textAlign: "center",
            x: am5.percent(50),
            centerX: am5.percent(50),
            paddingBottom: 10
          })
        );

        // Add export
        var exporting = am5plugins_exporting.Exporting.new(root, {
          menu: am5plugins_exporting.ExportingMenu.new(root, {}),
          dataSource: dataMerged,
        });

        unifiedChart.appear(1000, 100);
      }

      // Apply visibility based on toggle states
      function applySeriesVisibility() {
        if (!allSeries || Object.keys(allSeries).length === 0) return;

        // Show/hide series
        Object.keys(seriesVisibility).forEach(function(pollutant) {
          const visible = seriesVisibility[pollutant];
          const intKey = pollutant + "_int";
          const extKey = pollutant + "_ext";

          if (allSeries[intKey]) {
            if (visible) {
              allSeries[intKey].show();
            } else {
              allSeries[intKey].hide();
            }
          }
          if (allSeries[extKey]) {
            if (visible) {
              allSeries[extKey].show();
            } else {
              allSeries[extKey].hide();
            }
          }
        });

        // Show/hide axes based on which series are visible
        if (allAxes && Object.keys(allAxes).length > 0) {
          // PM axis: visible if any PM series is visible
          const pmVisible = seriesVisibility.PM1 || seriesVisibility.PM25 || seriesVisibility.PM10;
          if (allAxes.PM) {
            if (pmVisible) {
              allAxes.PM.show();
            } else {
              allAxes.PM.hide();
            }
          }

          // Other axes: one-to-one mapping
          if (allAxes.TEMP) {
            if (seriesVisibility.TEMP) {
              allAxes.TEMP.show();
            } else {
              allAxes.TEMP.hide();
            }
          }

          if (allAxes.HUM) {
            if (seriesVisibility.HUM) {
              allAxes.HUM.show();
            } else {
              allAxes.HUM.hide();
            }
          }

          if (allAxes.COV) {
            if (seriesVisibility.COV) {
              allAxes.COV.show();
            } else {
              allAxes.COV.hide();
            }
          }

          if (allAxes.CO2) {
            if (seriesVisibility.CO2) {
              allAxes.CO2.show();
            } else {
              allAxes.CO2.hide();
            }
          }
        }
      }

      // Toggle series visibility
      function toggleSeries(pollutant) {
        seriesVisibility[pollutant] = !seriesVisibility[pollutant];

        // Update button state
        const btn = document.querySelector('.toggle-btn[data-series="' + pollutant + '"]');
        if (btn) {
          btn.classList.toggle('active', seriesVisibility[pollutant]);
        }

        // Apply to chart
        applySeriesVisibility();
      }

      function gaugeCreator(root, measure, type) {
        //console.log(measure);

        root.numberFormatter.set("numberFormat", "####");

        root.setThemes([am5themes_Animated.new(root)]);

        let chart = root.container.children.push(
          am5radar.RadarChart.new(root, {
            panX: false,
            panY: false,
            startAngle: 160,
            endAngle: 380,
          })
        );

        let axisRenderer = am5radar.AxisRendererCircular.new(root, {
          innerRadius: -20,
          minGridDistance: 50,
        });

        axisRenderer.grid.template.setAll({
          stroke: root.interfaceColors.get("background"),
          visible: false,
          strokeOpacity: 0.8,
        });

        let minimum;
        let maximum;

        switch (type) {
          case "PM1":
            minimum = 0;
            maximum = 100;
            break;
          case "PM25":
            minimum = 0;
            maximum = 100;
            break;
          case "PM10":
            minimum = 0;
            maximum = 200;
            break;
          case "CO2":
            minimum = 400;
            maximum = 3000;
            break;
        }

        let xAxis = chart.xAxes.push(
          am5xy.ValueAxis.new(root, {
            maxDeviation: 0,
            min: minimum,
            max: maximum,
            strictMinMax: true,
            renderer: axisRenderer,
          })
        );

        let axisDataItem = xAxis.makeDataItem({});

        let clockHand = am5radar.ClockHand.new(root, {
          pinRadius: am5.percent(20),
          radius: am5.percent(35),
          bottomWidth: 20,
        });

        let bullet = axisDataItem.set(
          "bullet",
          am5xy.AxisBullet.new(root, {
            sprite: clockHand,
          })
        );

        xAxis.createAxisRange(axisDataItem);

        let label = chart.radarContainer.children.push(
          am5.Label.new(root, {
            fill: am5.color(0xffffff),
            centerX: am5.percent(50),
            textAlign: "center",
            centerY: am5.percent(50),
            fontSize: "1em",
          })
        );

        axisDataItem.set("value", 0);
        bullet.get("sprite").on("rotation", function () {
          let value = axisDataItem.get("value");
          let text = Math.round(axisDataItem.get("value")).toString();
          let fill = am5.color(0x000000);
          xAxis.axisRanges.each(function (axisRange) {
            if (
              value >= axisRange.get("value") &&
              value <= axisRange.get("endValue")
            ) {
              fill = axisRange.get("axisFill").get("fill");
            }
          });

          label.set("text", Math.round(value).toString());
          clockHand.pin.animate({
            key: "fill",
            to: fill,
            duration: 500,
            easing: am5.ease.out(am5.ease.cubic),
          });
          clockHand.hand.animate({
            key: "fill",
            to: fill,
            duration: 500,
            easing: am5.ease.out(am5.ease.cubic),
          });
        });

        // if(value.connected){
        setTimeout(function () {
          axisDataItem.animate({
            key: "value",
            to: Math.round(measure[type]),
            duration: 500,
            easing: am5.ease.out(am5.ease.cubic),
          });
        }, 1000);

        chart.bulletsContainer.set("mask", undefined);

        let bandsData;
        let title;
        let undertitle;

        if (type == "PM25" || type == "PM1") {
          bandsData = [
            {
              // title: "Bon",
              color: "#4FF0E6",
              lowScore: 0,
              highScore: 10,
            },
            {
              // title: "Moyen",
              color: "#51CCAA",
              lowScore: 10,
              highScore: 20,
            },
            {
              // title: "Dégradé",
              color: "#EDE663",
              lowScore: 20,
              highScore: 25,
            },
            {
              // title: "Mauvais",
              color: "#ED5E58",
              lowScore: 25,
              highScore: 50,
            },
            {
              // title: "Très mauvais",
              color: "#881B33",
              lowScore: 50,
              highScore: 75,
            },
            {
              // title: "Extr. mauvais",
              color: "#74287D",
              lowScore: 75,
              highScore: 100,
            },
          ];
        }

        if (type == "PM10") {
          bandsData = [
            {
              // title: "Bon",
              color: "#4FF0E6",
              lowScore: 0,
              highScore: 20,
            },
            {
              // title: "Moyen",
              color: "#51CCAA",
              lowScore: 20,
              highScore: 40,
            },
            {
              // title: "Dégradé",
              color: "#EDE663",
              lowScore: 40,
              highScore: 50,
            },
            {
              // title: "Mauvais",
              color: "#ED5E58",
              lowScore: 50,
              highScore: 100,
            },
            {
              // title: "Très mauvais",
              color: "#881B33",
              lowScore: 100,
              highScore: 150,
            },
            {
              // title: "Extr. mauvais",
              color: "#74287D",
              lowScore: 150,
              highScore: 200,
            },
          ];
        }

        if (type == "CO2") {
          bandsData = [
            {
              color: "#51CCAA",
              lowScore: 400,
              highScore: 800,
            },
            {
              color: "#EDE663",
              lowScore: 800,
              highScore: 1500,
            },
            {
              color: "#881B33",
              lowScore: 1500,
              highScore: 3000,
            },
          ];
        }

        switch (type) {
          case "PM1":
            title = "PM1";
            undertitle = "µg/m³";
            break;
          case "PM25":
            title = "PM2.5";
            undertitle = "µg/m³";
            break;
          case "PM10":
            title = "PM10";
            undertitle = "µg/m³";
            break;
          case "CO2":
            title = "CO₂";
            undertitle = "ppm";
            break;
        }

        am5.array.each(bandsData, function (data) {
          let axisRange = xAxis.createAxisRange(xAxis.makeDataItem({}));

          axisRange.setAll({
            value: data.lowScore,
            endValue: data.highScore,
          });

          axisRange.get("axisFill").setAll({
            visible: true,
            fill: am5.color(data.color),
            fillOpacity: 1,
          });
        });

        chart.children.unshift(
          am5.Label.new(root, {
            text: undertitle,
            fontSize: 10,
            textAlign: "center",
            x: am5.percent(50),
            centerX: am5.percent(50),
            paddingTop: 15,
          })
        );

        chart.children.unshift(
          am5.Label.new(root, {
            text: title,
            fontSize: 15,
            fontWeight: "500",
            textAlign: "center",
            x: am5.percent(50),
            centerX: am5.percent(50),
            paddingTop: 0,
            paddingBottom: 0,
          })
        );

        chart.appear(1000, 100);
      }

      function reloadDataSensor(hours, timespan) {
        console.log("RELOAD DATA SENSORS function");
        
        console.log(
          "%ModuleAir 1 sensor",
          "color: yellow; font-style: bold; background-color: blue;padding: 2px"
        );

        console.log("Historique: " + hours);
        console.log("Pas de temps: " + timespan);

        const end = new Date();
        const end_string = end.toISOString();
        const get_start = end.setHours(end.getHours() - hours);
        const start = new Date(get_start);
        const start_string = start.toISOString();
        //console.log(start_string);
        //console.log(end_string);

        switch (timespan) {
          case 2:
            timespan = "2m";
            break;
          case 15:
            timespan = "15m";
            break;
          case 60:
            timespan = "1h";
            break;
          case 1440:
            timespan = "1d";
            break;
        }

        if (nebuleair != null) {
          console.log(
            "https://api.aircarto.fr/capteurs/dataNebuleAir?capteurID=" +
              nebuleair +
              "&start=" +
              start_string +
              "&end=" +
              end_string +
              "&freq=" +
              timespan
          );

          $.ajax({
            method: "GET",
            url:
              "https://api.aircarto.fr/capteurs/dataNebuleAir?capteurID=" +
              nebuleair +
              "&start=" +
              start_string +
              "&end=" +
              end_string +
              "&freq=" +
              timespan,
          })
            .done(function (data) {
              console.log(data);
              dataNebuleAir = data;

              if (data == null) {
                openToast("Pas de donnée NebuleAir sur cet intervalle.");
              }
            })
            .fail(function () {
              console.log("Error while geting data from Aircarto API");
            });
        }

        console.log(
          "https://api.aircarto.fr/capteurs/dataModuleAir?capteurID=" +
            moduleair +
            "&start=" +
            start_string +
            "&end=" +
            end_string +
            "&freq=" +
            timespan +
            "&token=" +
            token
        );

        $.ajax({
          method: "GET",
          url:
            "https://api.aircarto.fr/capteurs/dataModuleAir?capteurID=" +
            moduleair +
            "&start=" +
            start_string +
            "&end=" +
            end_string +
            "&freq=" +
            timespan +
            "&token=" +
            token,
        })
          .done(function (data) {
            console.log(data);
            if (data != null) {
              // Dispose old unified chart if exists
              if (rootUnified != undefined) {
                rootUnified.dispose();
              }

              setTimeout(function () {
                am5.ready(function () {
                  // Create unified chart
                  rootUnified = am5.Root.new("unifiedChart");
                  unifiedGraphCreator(
                    rootUnified,
                    data,
                    dataNebuleAir,
                    timespanGraph,
                    data[data.length - 1].sensorId
                  );
                });
              }, 1000);
            } else {
              openToast(
                "Pas de donnée sur cet intervalle. Veuillez choisir une période plus longue."
              );
            }
          })
          .fail(function () {
            console.log("Error while geting data from Aircarto API");
          });
      }

      function refresh_data() {
        console.log("REFRESH DATA");
        submit();
      }

      function chooseTimeModuleAir(id, hours, timespan) {
        timeLengthGraph = hours;
        timespanGraph = timespan;
        reloadDataSensor(hours, timespan);
        document.getElementById("button1h").innerHTML =
          '<button type="button" onclick="chooseTimeModuleAir(\'' + id + "',1," + timespanGraph + ')" class="time-btn">1h</button>';
        document.getElementById("button3h").innerHTML =
          '<button type="button" onclick="chooseTimeModuleAir(\'' + id + "',3," + timespanGraph + ')" class="time-btn">3h</button>';
        document.getElementById("button24h").innerHTML =
          '<button type="button" onclick="chooseTimeModuleAir(\'' + id + "',24," + timespanGraph + ')" class="time-btn">24h</button>';
        document.getElementById("button48h").innerHTML =
          '<button type="button" onclick="chooseTimeModuleAir(\'' + id + "',48," + timespanGraph + ')" class="time-btn">48h</button>';
        document.getElementById("button1s").innerHTML =
          '<button type="button" onclick="chooseTimeModuleAir(\'' + id + "',168," + timespanGraph + ')" class="time-btn">1 sem</button>';
        document.getElementById("button1m").innerHTML =
          '<button type="button" onclick="chooseTimeModuleAir(\'' + id + "',720," + timespanGraph + ')" class="time-btn">1 mois</button>';
        document.getElementById("button1a").innerHTML =
          '<button type="button" onclick="chooseTimeModuleAir(\'' + id + "',8760," + timespanGraph + ')" class="time-btn">1 an</button>';
        document.getElementById("button2m").innerHTML =
          '<button type="button" onclick="chooseTimeModuleAir(\'' + id + "'," + timeLengthGraph + ',2)" class="time-btn">2m</button>';
        document.getElementById("button15m").innerHTML =
          '<button type="button" onclick="chooseTimeModuleAir(\'' + id + "'," + timeLengthGraph + ',15)" class="time-btn">15m</button>';
        document.getElementById("button60m").innerHTML =
          '<button type="button" onclick="chooseTimeModuleAir(\'' + id + "'," + timeLengthGraph + ',60)" class="time-btn">1h</button>';
        document.getElementById("button1440m").innerHTML =
          '<button type="button" onclick="chooseTimeModuleAir(\'' + id + "'," + timeLengthGraph + ',1440)" class="time-btn">24h</button>';
        buttonsSwitcher(hours, timespan);
      }

      function buttonsSwitcher(hours, timespan) {
        // Hour buttons mapping
        const hourButtons = {
          1: "button1h", 3: "button3h", 24: "button24h",
          48: "button48h", 168: "button1s", 720: "button1m", 8760: "button1a"
        };

        // Timespan buttons mapping
        const timespanButtons = {
          2: "button2m", 15: "button15m", 60: "button60m", 1440: "button1440m"
        };

        // Update hour buttons
        Object.keys(hourButtons).forEach(function(h) {
          const btn = document.getElementById(hourButtons[h]).children[0];
          if (parseInt(h) === hours) {
            btn.classList.add("active");
          } else {
            btn.classList.remove("active");
          }
        });

        // Update timespan buttons
        Object.keys(timespanButtons).forEach(function(t) {
          const btn = document.getElementById(timespanButtons[t]).children[0];
          if (parseInt(t) === timespan) {
            btn.classList.add("active");
          } else {
            btn.classList.remove("active");
          }
        });

        // Disable 1 year button for small timespans
        const btn1a = document.getElementById("button1a").children[0];
        if (timespan == 2 || timespan == 15) {
          btn1a.setAttribute("disabled", "");
        } else {
          btn1a.removeAttribute("disabled");
        }

        // Disable small timespans for 1 year period
        const btn2m = document.getElementById("button2m").children[0];
        const btn15m = document.getElementById("button15m").children[0];
        if (hours == 8760) {
          btn2m.setAttribute("disabled", "");
          btn15m.setAttribute("disabled", "");
        } else {
          btn2m.removeAttribute("disabled");
          btn15m.removeAttribute("disabled");
        }
      }

      function logout() {
        // Clear localStorage credentials
        localStorage.removeItem("moduleair_id");
        localStorage.removeItem("moduleair_token");
        location.reload();
      }

      function reloadPage() {
        location.reload();
      }

      function addr_search() {
        var inp = document.getElementById("addr");
        var xmlhttp = new XMLHttpRequest();
        var url =
          "https://nominatim.openstreetmap.org/search?format=json&limit=3&q=" +
          inp.value;
        xmlhttp.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            var myArr = JSON.parse(this.responseText);
            adressResult(myArr);
          }
        };
        xmlhttp.open("GET", url, true);
        xmlhttp.send();
      }

      function adressResult(arr) {
        var out = "";
        var i;

        if (arr.length > 0) {
          for (i = 0; i < arr.length; i++) {
            out +=
              "<div class='address' title='Show Location and Coordinates' onclick='chooseAddr(" +
              arr[i].lat +
              ", " +
              arr[i].lon +
              ");return false;'>" +
              arr[i].display_name +
              "</div>";
          }
          document.getElementById("results").innerHTML = out;
        } else {
          document.getElementById("results").innerHTML = "Sorry, no results...";
        }
      }

      function chooseAddr(lat1, lng1) {
        myMarker.closePopup();
        map.setView([lat1, lng1], 18);
        myMarker.setLatLng([lat1, lng1]);
        lat = lat1.toFixed(8);
        lon = lng1.toFixed(8);
        document.getElementById("lat").value = lat;
        document.getElementById("lon").value = lon;
        myMarker.bindPopup("Lat " + lat + "<br />Lon " + lon).openPopup();
      }

      function updateLocation() {
        let lat = document.querySelector("#lat").value;
        let lng = document.querySelector("#lon").value;

        console.log(
          "https://api.aircarto.fr/capteurs/changeLoc?capteurID=" +
            moduleair +
            "&lat=" +
            lat +
            "&long=" +
            lng +
            "&token=" +
            token
        );

        $.ajax({
          method: "POST",
          url:
            "https://api.aircarto.fr/capteurs/changeLoc?capteurID=" +
            moduleair +
            "&lat=" +
            lat +
            "&long=" +
            lng +
            "&token=" +
            token,
          success: function (result) {
            openToast("Adresse modifiée.");
          },
        }).fail(function () {
          console.log("Error while posting data to Aircarto API");
          openToast("Erreur pour le changement de localisation.");
        });
      }

      function updateLink() {
        let nebuleair = "nebuleair-" + document.querySelector("#linkNebuleAir").value;

        console.log(
          "https://api.aircarto.fr/capteurs/link?capteurID_ModuleAir=" +
            moduleair +
            "&capteurID_NebuleAir=" +
            nebuleair +
            "&token=" +
            token
        );

        $.ajax({
          method: "GET",
          url:
            "https://api.aircarto.fr/capteurs/link?capteurID_ModuleAir=" +
            moduleair +
            "&capteurID_NebuleAir=" +
            nebuleair +
            "&token=" +
            token,
        })
          .done(function (data) {
            console.log(data);
            //location.reload(); //RELOAD THE PAGE
            //document.querySelector("#linkNebuleAir").value = 


            // if (data != null) {
            //   if (
            //     root5 != undefined &&
            //     root6 != undefined &&
            //     root7 != undefined &&
            //     root8 != undefined
            //   ) {
            //     root5.dispose();
            //     root6.dispose();
            //     root7.dispose();
            //     root8.dispose();
            //   }

            //   setTimeout(function () {
            //     am5.ready(function () {
            //       root5 = am5.Root.new("chartdiv5");
            //       graphCreator(
            //         root5,
            //         data,
            //         dataNebuleAir,
            //         "PM",
            //         timespanGraph,
            //         data[data.length - 1].sensorId
            //       );

            //       root6 = am5.Root.new("chartdiv6");
            //       graphCreator(
            //         root6,
            //         data,
            //         dataNebuleAir,
            //         "THP",
            //         timespanGraph,
            //         data[data.length - 1].sensorId
            //       );

            //       root7 = am5.Root.new("chartdiv7");
            //       graphCreator(
            //         root7,
            //         data,
            //         dataNebuleAir,
            //         "COV",
            //         timespanGraph,
            //         data[data.length - 1].sensorId
            //       );

            //       root8 = am5.Root.new("chartdiv8");
            //       graphCreator(
            //         root8,
            //         data,
            //         dataNebuleAir,
            //         "CO2",
            //         timespanGraph,
            //         data[data.length - 1].sensorId
            //       );
            //     });
            //   }, 1000);
            // } else {
            //   openToast(
            //     "Pas de donnée sur cet intervalle. Veuillez choisir une période plus longue."
            //   );
            // }




            
          })
          .fail(function () {
            console.log("Error while posting data to Aircarto API");
          });
      }

      function changeRoom(event){

        let room;

        console.log(event.target.value);

        $.ajax({
          method: "POST",
          url:
            "https://api.aircarto.fr/capteurs/changeRoom?capteurID=" +
            moduleair +
            "&room=" +
            event.target.value +
            "&token=" +
            token,
          success: function (result) {
              openToast("Pièce changée.");
          },
        }).fail(function () {
          console.log("Error while posting data to Aircarto API");
          openToast("Erreur pour le changement de la pièce.");
        });
      }

      function openToast(message) {
        let toastDiv = document.getElementById("messageToast");
        document.getElementById("message").innerText = message;
        let toastBootstrap = bootstrap.Toast.getOrCreateInstance(toastDiv);
        console.log("Showing message toast");
        toastBootstrap.show();
      }

      function timeDateCounter(timestamp) {
        const timestamp_UTC = new Date(timestamp);
        const now = Date.now();

        let difference = Math.floor((now - timestamp_UTC) / 86400000);

        var date_texte = "";
        let horaire_texte = "";

        switch (difference) {
          case 0:
            date_texte = "aujourd'hui";
            break;
          case 1:
            date_texte = "hier";
            break;
          case 2:
            date_texte = "avant-hier";
            break;
          default:
            date_texte += "le ";
            if (timestamp_UTC.getDate() < 10) {
              date_texte += "0";
              date_texte += timestamp_UTC.getDate();
            } else {
              date_texte += timestamp_UTC.getDate();
            }
            date_texte += "/";
            if (timestamp_UTC.getMonth() + 1 < 10) {
              date_texte += "0";
              date_texte += timestamp_UTC.getMonth() + 1;
            } else {
              date_texte += timestamp_UTC.getMonth() + 1;
            }
            date_texte += "/";
            date_texte += timestamp_UTC.getFullYear();
        }

        //horaire
        if (timestamp_UTC.getHours() < 10) {
          horaire_texte += "0";
          horaire_texte += timestamp_UTC.getHours();
        } else {
          horaire_texte += timestamp_UTC.getHours();
        }
        horaire_texte += "h";
        if (timestamp_UTC.getMinutes() < 10) {
          horaire_texte += "0";
          horaire_texte += timestamp_UTC.getMinutes();
        } else {
          horaire_texte += timestamp_UTC.getMinutes();
        }

        return date_texte + " à " + horaire_texte;
      }
    </script>
    <script
      src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
      integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
      crossorigin="anonymous"
    ></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.3/dist/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script> -->
    <script
      src="https://code.jquery.com/jquery-3.6.1.js"
      integrity="sha256-3zlB5s2uwoUzrXK3BT7AX3FyvojsraNFxCc2vC/7pNI="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"
      integrity="sha384-fbbOQedDUMZZ5KreZpsbe1LCZPVmfTnH7ois6mU1QK+m14rQ1l2bGBq41eYeM/fS"
      crossorigin="anonymous"
    ></script>
    <script>
      var tooltipTriggerList = [].slice.call(
        document.querySelectorAll('[data-bs-toggle="tooltip"]')
      );
      var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });
    </script>
  </body>
</html>
